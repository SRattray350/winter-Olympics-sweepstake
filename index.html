<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Office Winter Olympics Sweepstake</title>
  <style>
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
      margin: 24px; 
      max-width: 1100px;
      background-image: url('background.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
    }
    .content-wrapper {
      background: rgba(255, 255, 255, 0.95);
      padding: 24px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }
    h1 { margin: 0 0 6px 0; }
    .sub { color: #555; margin: 0 0 18px 0; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin: 10px 0 18px; }
    input { padding: 10px; border: 1px solid #ddd; border-radius: 10px; min-width: 260px; }
    button { padding: 10px 12px; border: 1px solid #ddd; background: #fff; border-radius: 10px; cursor: pointer; }
    button:hover { background: #f6f6f6; }
    table { border-collapse: collapse; width: 100%; background: white; }
    th, td { border-bottom: 1px solid #eee; padding: 10px 8px; text-align: left; }
    th { font-weight: 650; }
    td.num, th.num { text-align: right; font-variant-numeric: tabular-nums; }
    tr.clickable { cursor: pointer; }
    tr.clickable:hover { background: #fafafa; }
    .pill { display:inline-block; padding: 3px 10px; border: 1px solid #eee; border-radius: 999px; font-size: 12px; color:#555; }
    .muted { color:#777; font-size: 13px; }

    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.28); display: none; }
    .drawer {
      position: fixed; top: 0; right: 0; height: 100%; width: min(560px, 94vw);
      background: #fff; border-left: 1px solid #eee; box-shadow: -10px 0 40px rgba(0,0,0,0.08);
      padding: 18px; overflow: auto; display: none;
    }
    .drawer h2 { margin: 0 0 8px 0; font-size: 20px; }
    .meta { display:flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .tag { background:#f6f6f6; border:1px solid #eee; border-radius: 999px; padding: 4px 10px; font-size: 12px; color:#444; }
    .closeRow { display:flex; justify-content: space-between; align-items: center; gap: 12px; }
    .closeBtn { border-radius: 10px; }
    .kpi { display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 8px 0 14px; }
    .card { border: 1px solid #eee; border-radius: 14px; padding: 10px 12px; }
    .card .big { font-size: 18px; font-weight: 700; }
    .card .lbl { font-size: 12px; color:#666; }
    .sectionTitle { margin: 14px 0 8px; font-size: 14px; color:#555; font-weight: 650; }
    .small { font-size: 12px; color:#666; }

    /* Reliable flags everywhere: use images (not emoji) */
    .flag-img {
      width: 18px;
      height: 13px;
      display: inline-block;
      vertical-align: -2px;
      margin-right: 6px;
      border-radius: 2px;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.06);
      object-fit: cover;
    }
  </style>
</head>
<body>
  <div class="content-wrapper">
    <h1>Office Winter Olympics Sweepstake</h1>
    <p class="sub">
      Live leaderboard (auto-refreshing). <span id="status" class="pill">Loading…</span>
      <span class="pill" style="margin-left:8px;">You can now click player names for a breakdown of their scores! :)</span>
    </p>

    <div class="row">
      <input id="search" placeholder="Search player…" />
      <button id="refresh">Refresh now</button>
      <span id="updated" class="muted"></span>
    </div>

    <table id="tbl"></table>
  </div>

  <div id="overlay" class="overlay"></div>
  <div id="drawer" class="drawer"></div>

  <!-- Audio player - hidden but autoplays -->
  <audio id="bgMusic" autoplay loop>
    <source src="music.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

<script>
  // ====== SET THESE TWO URLS ======
  const LEADERBOARD_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTv_B6jdgEx4q3c9uhSISHuVdhUfubFMblfU0FJXop_rv7jniIO_y44H-ARvrjassAOOi0xhDIgxMYW/pub?gid=37582016&single=true&output=csv";
  const MEDALLOG_CSV_URL    = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTv_B6jdgEx4q3c9uhSISHuVdhUfubFMblfU0FJXop_rv7jniIO_y44H-ARvrjassAOOi0xhDIgxMYW/pub?gid=1029591436&single=true&output=csv";

  const withNoCache = (url) => url + (url.includes("?") ? "&" : "?") + "t=" + Date.now();

  function parseCSV(text) {
    const rows = [];
    let row = [], field = "", inQuotes = false;
    for (let i = 0; i < text.length; i++) {
      const c = text[i], next = text[i + 1];
      if (c === '"' && inQuotes && next === '"') { field += '"'; i++; continue; }
      if (c === '"') { inQuotes = !inQuotes; continue; }
      if (c === "," && !inQuotes) { row.push(field); field = ""; continue; }
      if ((c === "\n" || c === "\r") && !inQuotes) {
        if (c === "\r" && next === "\n") i++;
        row.push(field);
        if (row.some(x => String(x).trim() !== "")) rows.push(row);
        row = []; field = "";
        continue;
      }
      field += c;
    }
    row.push(field);
    if (row.some(x => String(x).trim() !== "")) rows.push(row);
    return rows;
  }

  const medalPoints = (medal) => {
    const m = String(medal || "").trim().toLowerCase();
    if (m === "gold") return 3;
    if (m === "silver") return 2;
    if (m === "bronze") return 1;
    return 0;
  };

  function toNumber(x) {
    const n = Number(String(x).replace(/[^\d.-]/g, ""));
    return Number.isFinite(n) ? n : 0;
  }

  function escapeHtml(s) {
    return String(s || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function buildIndex(headers) {
    const idx = {};
    headers.forEach((h, i) => idx[String(h).trim().toLowerCase()] = i);
    return idx;
  }

  function ordinal(n) {
    if (!n) return "";
    const s = ["th","st","nd","rd"];
    const v = n % 100;
    return n + (s[(v - 20) % 10] || s[v] || s[0]);
  }

  // --- Reliable flag HTML via CDN images ---
  // Uses ISO 3166-1 alpha-2 lowercase (e.g., "LT" -> "lt")
  function flagHTML(iso) {
    const code = String(iso || "").trim().toLowerCase();
    if (!/^[a-z]{2}$/.test(code)) return "";
    // 24x18 is a good small size; browser will scale down to our CSS size.
    return `<img class="flag-img" alt="${escapeHtml(code.toUpperCase())}" src="https://flagcdn.com/24x18/${code}.png" loading="lazy" decoding="async">`;
  }

  let leaderboardHeaders = [];
  let lbIdx = {};
  let fullRows = [];
  let medalLog = [];

  let topMedalsByPlayer = {}; // medals by rank 1/2/3
  let positionByPlayer = {};  // dense rank 1,2,2,3,...

  function renderTable(headers, data, onRowClick) {
    const tbl = document.getElementById("tbl");
    tbl.innerHTML = "";

    const hideCols = new Set(["iso1","iso2","iso3"]);

    const visibleCols = [];
    headers.forEach((h, i) => {
      const key = String(h).trim().toLowerCase();
      if (!hideCols.has(key)) visibleCols.push(i);
    });

    const thead = document.createElement("thead");
    const trh = document.createElement("tr");

    const thPos = document.createElement("th");
    thPos.textContent = "Position";
    trh.appendChild(thPos);

    visibleCols.forEach((i) => {
      const h = headers[i];
      const th = document.createElement("th");
      th.textContent = h;
      if (["Gold","Silver","Bronze","Points","Bonus","Total"].includes(h)) th.classList.add("num");
      trh.appendChild(th);
    });

    thead.appendChild(trh);
    tbl.appendChild(thead);

    const tbody = document.createElement("tbody");
    data.forEach(r => {
      const tr = document.createElement("tr");
      tr.classList.add("clickable");
      tr.addEventListener("click", () => onRowClick(r));

      const playerNameForPos = String(r[lbIdx["player"] ?? 0] || "").trim();
      const posNum = positionByPlayer[playerNameForPos];
      const tdPos = document.createElement("td");
      tdPos.textContent = posNum ? ordinal(posNum) : "";
      tr.appendChild(tdPos);

      visibleCols.forEach((i) => {
        const header = headers[i];
        const cell = r[i];

        const td = document.createElement("td");
        const hLower = String(header).trim().toLowerCase();

        if (hLower === "player") {
          const name = String(cell || "");
          const medal = topMedalsByPlayer[String(name).trim()] || "";
          td.textContent = medal ? (medal + " " + name) : name;

        } else if (hLower === "country 1" || hLower === "country 2" || hLower === "country 3") {
          const n = hLower.endsWith("1") ? "1" : (hLower.endsWith("2") ? "2" : "3");
          const isoIdx = lbIdx["iso" + n];
          const isoCode = isoIdx !== undefined ? String(r[isoIdx]).trim().toUpperCase() : "";
          td.innerHTML = `${flagHTML(isoCode)}${escapeHtml(cell)}`;

        } else {
          td.textContent = cell;
        }

        if (["Gold","Silver","Bronze","Points","Bonus","Total"].includes(header)) td.classList.add("num");
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });
    tbl.appendChild(tbody);
  }

  async function loadMedalLog() {
    const res = await fetch(withNoCache(MEDALLOG_CSV_URL), { cache: "no-store" });
    const text = await res.text();
    const rows = parseCSV(text).filter(r => r.s
