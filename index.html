<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Office Winter Olympics Sweepstake</title>

<style>
  body {
    margin: 0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:
      linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)),
      url("background.jpg"); /* <-- your uploaded image */
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    color: #111;
  }

  .wrap {
    max-width: 1000px;
    margin: 0 auto;
    padding: 24px;
  }

  .card {
    background: rgba(255,255,255,0.92);
    border-radius: 18px;
    padding: 18px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.25);
  }

  h1 { margin: 0 0 6px; }
  .sub { color: #555; margin-bottom: 14px; }

  .row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 14px;
  }

  input {
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #ddd;
    min-width: 260px;
  }

  button {
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid #ddd;
    background: #fff;
    cursor: pointer;
    font-weight: 600;
  }

  button:hover { background: #f4f4f4; }

  .pill {
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid #ddd;
    font-size: 12px;
    color: #444;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  th, td {
    padding: 10px 8px;
    border-bottom: 1px solid #e0e0e0;
  }

  th {
    text-align: left;
    font-weight: 700;
  }

  td.num, th.num {
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  img.flag {
    vertical-align: middle;
    margin-right: 6px;
    border-radius: 2px;
    border: 1px solid rgba(0,0,0,0.15);
  }

  #yt {
    width: 0;
    height: 0;
    overflow: hidden;
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>Office Winter Olympics Sweepstake</h1>
    <p class="sub">
      Live leaderboard <span id="status" class="pill">Loading‚Ä¶</span>
    </p>

    <div class="row">
      <input id="search" placeholder="Search player‚Ä¶" />
      <button id="refresh">Refresh</button>
      <button id="musicBtn">üî• Intense music</button>
      <span id="updated" class="pill"></span>
    </div>

    <table id="tbl"></table>
  </div>
</div>

<div id="yt"></div>

<script>
/* ============================
   CONFIG
============================ */
const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vTv_B6jdgEx4q3c9uhSISHuVdhUfubFMblfU0FJXop_rv7jniIO_y44H-ARvrjassAOOi0xhDIgxMYW/pub?gid=37582016&single=true&output=csv";

const VIDEO_ID = "zRs58D34OLY";

/* ============================
   HELPERS
============================ */
const csvNoCache = () => CSV_URL + "&t=" + Date.now();

function parseCSV(text) {
  const rows = [];
  let row = [], field = "", inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const c = text[i], n = text[i+1];
    if (c === '"' && inQuotes && n === '"') { field += '"'; i++; continue; }
    if (c === '"') { inQuotes = !inQuotes; continue; }
    if (c === "," && !inQuotes) { row.push(field); field=""; continue; }
    if ((c === "\n" || c === "\r") && !inQuotes) {
      if (c === "\r" && n === "\n") i++;
      row.push(field); rows.push(row);
      row=[]; field=""; continue;
    }
    field += c;
  }
  row.push(field); rows.push(row);
  return rows;
}

function toNum(x){
  const n = Number(String(x).replace(/[^\d.-]/g,""));
  return Number.isFinite(n) ? n : 0;
}

function flag(code){
  if(!code) return "";
  const c = code.toLowerCase();
  return `<img class="flag" src="https://flagcdn.com/w20/${c}.png"
          srcset="https://flagcdn.com/w40/${c}.png 2x"
          width="20" height="15">`;
}

/* ============================
   LOAD & RENDER
============================ */
async function load(){
  document.getElementById("status").textContent = "Updating‚Ä¶";
  const res = await fetch(csvNoCache(), {cache:"no-store"});
  const text = await res.text();
  const rows = parseCSV(text);
  if(rows.length < 2) return;

  const headers = rows[0];
  const data = rows.slice(1).filter(r => r[0]);

  const idx = name => headers.findIndex(h => h.toLowerCase() === name);

  const p = idx("player");
  const g = idx("gold");
  const s = idx("silver");
  const b = idx("bronze");
  const t = idx("total");
  const c1 = idx("country 1"), c2 = idx("country 2"), c3 = idx("country 3");
  const i1 = idx("iso1"), i2 = idx("iso2"), i3 = idx("iso3");

  data.sort((a,b) =>
    toNum(b[t]) - toNum(a[t]) ||
    toNum(b[g]) - toNum(a[g]) ||
    toNum(b[s]) - toNum(a[s]) ||
    toNum(b[b]) - toNum(a[b])
  );

  const tbl = document.getElementById("tbl");
  tbl.innerHTML = "";

  const thead = document.createElement("thead");
  thead.innerHTML = `
    <tr>
      <th>Player</th>
      <th class="num">Gold</th>
      <th class="num">Silver</th>
      <th class="num">Bronze</th>
      <th class="num">Total</th>
      <th>Countries</th>
    </tr>`;
  tbl.appendChild(thead);

  const tbody = document.createElement("tbody");
  data.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r[p]}</td>
      <td class="num">${r[g]}</td>
      <td class="num">${r[s]}</td>
      <td class="num">${r[b]}</td>
      <td class="num"><b>${r[t]}</b></td>
      <td>
        ${flag(r[i1])}${r[c1]}&nbsp;&nbsp;
        ${flag(r[i2])}${r[c2]}&nbsp;&nbsp;
        ${flag(r[i3])}${r[c3]}
      </td>`;
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);

  document.getElementById("updated").textContent =
    "Updated " + new Date().toLocaleTimeString();
  document.getElementById("status").textContent = "Live";
}

document.getElementById("refresh").onclick = load;
load();
setInterval(load, 60000);

/* ============================
   MUSIC
============================ */
let playing = false;

document.getElementById("musicBtn").onclick = () => {
  const yt = document.getElementById("yt");
  if(!playing){
    yt.innerHTML =
      `<iframe width="0" height="0"
        src="https://www.youtube.com/embed/${VIDEO_ID}?autoplay=1&loop=1&playlist=${VIDEO_ID}"
        allow="autoplay"></iframe>`;
    document.getElementById("musicBtn").textContent = "‚è∏ Stop music";
    playing = true;
  } else {
    yt.innerHTML = "";
    document.getElementById("musicBtn").textContent = "üî• Intense music";
    playing = false;
  }
};
</script>
</body>
</html>
