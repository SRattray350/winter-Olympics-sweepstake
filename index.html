<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Office Winter Olympics Sweepstake</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; max-width: 980px; }
    h1 { margin: 0 0 6px 0; }
    .sub { color: #555; margin: 0 0 18px 0; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin: 10px 0 18px; }
    input { padding: 10px; border: 1px solid #ddd; border-radius: 10px; min-width: 260px; }
    button { padding: 10px 12px; border: 1px solid #ddd; background: #fff; border-radius: 10px; cursor: pointer; }
    button:hover { background: #f6f6f6; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border-bottom: 1px solid #eee; padding: 10px 8px; text-align: left; }
    th { font-weight: 650; }
    td.num, th.num { text-align: right; font-variant-numeric: tabular-nums; }
    .pill { display:inline-block; padding: 3px 10px; border: 1px solid #eee; border-radius: 999px; font-size: 12px; color:#555; }
    .muted { color:#777; font-size: 13px; }
    img.flag { vertical-align: middle; margin-right: 6px; border: 1px solid #eee; border-radius: 2px; }
  </style>
</head>
<body>
  <h1>Office Winter Olympics Sweepstake</h1>
  <p class="sub">
    Live leaderboard (auto-refreshing). <span id="status" class="pill">Loading…</span>
  </p>

  <div class="row">
    <input id="search" placeholder="Search player…" />
    <button id="refresh">Refresh now</button>
    <span id="updated" class="muted"></span>
  </div>

  <table id="tbl"></table>

<script>
  // Paste your published Leaderboard CSV URL here:
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTv_B6jdgEx4q3c9uhSISHuVdhUfubFMblfU0FJXop_rv7jniIO_y44H-ARvrjassAOOi0xhDIgxMYW/pub?gid=37582016&single=true&output=csv";

  // Expected CSV columns (0-based):
  // 0 Player, 1 Gold, 2 Silver, 3 Bronze, 4 Points,
  // 5 Country 1, 6 Country 2, 7 Country 3,
  // 8 Flag 1 (emoji), 9 Flag 2 (emoji), 10 Flag 3 (emoji),
  // 11 ISO1, 12 ISO2, 13 ISO3
  //
  // On the website we will HIDE emoji flags + ISO columns,
  // and instead show real flag images next to Country 1/2/3.
  const HIDE_COLS = new Set([8, 9, 10, 11, 12, 13]);

  // Cache-bust so GitHub Pages always shows fresh data
  const csvWithNoCache = () => CSV_URL + (CSV_URL.includes("?") ? "&" : "?") + "t=" + Date.now();

  // Minimal CSV parser that handles quoted commas
  function parseCSV(text) {
    const rows = [];
    let row = [], field = "", inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      const next = text[i + 1];

      if (c === '"' && inQuotes && next === '"') { field += '"'; i++; continue; }
      if (c === '"') { inQuotes = !inQuotes; continue; }

      if (c === "," && !inQuotes) { row.push(field); field = ""; continue; }
      if ((c === "\n" || c === "\r") && !inQuotes) {
        if (c === "\r" && next === "\n") i++;
        row.push(field);
        if (row.length > 1 || (row.length === 1 && row[0].trim() !== "")) rows.push(row);
        row = []; field = "";
        continue;
      }
      field += c;
    }

    row.push(field);
    if (row.length > 1 || (row.length === 1 && row[0].trim() !== "")) rows.push(row);
    return rows;
  }

  function toNumber(x) {
    const n = Number(String(x).replace(/[^\d.-]/g, ""));
    return Number.isFinite(n) ? n : 0;
  }

  function flagImg(code) {
    if (!code) return "";
    const c = String(code).trim().toLowerCase();
    // flagcdn uses ISO2 lowercase codes
    return `<img class="flag"
                 src="https://flagcdn.com/w20/${c}.png"
                 srcset="https://flagcdn.com/w40/${c}.png 2x"
                 width="20" height="15" alt="${c}">`;
  }

  let fullData = [];
  let fullHeaders = [];

  function renderTable(headers, data) {
    const tbl = document.getElementById("tbl");
    tbl.innerHTML = "";

    // Decide which columns to keep visible
    const keptIdx = headers.map((_, i) => i).filter(i => !HIDE_COLS.has(i));
    const keptHeaders = keptIdx.map(i => headers[i]);

    const thead = document.createElement("thead");
    const trh = document.createElement("tr");

    keptHeaders.forEach((h, visibleIdx) => {
      const th = document.createElement("th");
      th.textContent = h;
      // numeric columns after filtering: Gold/Silver/Bronze/Points are still visible indices 1..4
      if (visibleIdx >= 1 && visibleIdx <= 4) th.classList.add("num");
      trh.appendChild(th);
    });

    thead.appendChild(trh);
    tbl.appendChild(thead);

    const tbody = document.createElement("tbody");

    data.forEach(r => {
      const tr = document.createElement("tr");

      keptIdx.forEach((colIdx, visibleIdx) => {
        const td = document.createElement("td");

        // Add image flags into Country columns using ISO columns.
        // Country cols are 5,6,7; ISO cols are 11,12,13
        if (colIdx === 5) td.innerHTML = flagImg(r[11]) + (r[5] || "");
        else if (colIdx === 6) td.innerHTML = flagImg(r[12]) + (r[6] || "");
        else if (colIdx === 7) td.innerHTML = flagImg(r[13]) + (r[7] || "");
        else td.textContent = r[colIdx] || "";

        if (visibleIdx >= 1 && visibleIdx <= 4) td.classList.add("num");
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });

    tbl.appendChild(tbody);
  }

  async function load() {
    const status = document.getElementById("status");
    status.textContent = "Updating…";

    const res = await fetch(csvWithNoCache(), { cache: "no-store" });
    const text = await res.text();

    const rows = parseCSV(text).filter(r => r.some(c => String(c).trim() !== ""));
    if (rows.length < 2) {
      status.textContent = "No data yet";
      renderTable(["Player","Gold","Silver","Bronze","Points","Country 1","Country 2","Country 3"], []);
      return;
    }

    const headers = rows[0];
    const data = rows.slice(1)
      .filter(r => String(r[0] || "").trim() !== "")
      .map(r => {
        const padded = [...r];
        // Ensure we have enough columns up to ISO3 (index 13)
        while (padded.length < 14) padded.push("");
        return padded;
      })
      // Sort like an Olympic table: Points, Gold, Silver, Bronze
      .sort((a,b) =>
        toNumber(b[4]) - toNumber(a[4]) ||
        toNumber(b[1]) - toNumber(a[1]) ||
        toNumber(b[2]) - toNumber(a[2]) ||
        toNumber(b[3]) - toNumber(a[3]) ||
        String(a[0]).localeCompare(String(b[0]))
      );

    fullHeaders = headers;
    fullData = data;

    // Apply current search filter (if any) before rendering
    const q = document.getElementById("search").value.trim().toLowerCase();
    const filtered = !q ? fullData : fullData.filter(r => String(r[0]).toLowerCase().includes(q));

    renderTable(fullHeaders, filtered);

    document.getElementById("updated").textContent =
      "Last refreshed: " + new Date().toLocaleString();

    status.textContent = "Live";
  }

  document.getElementById("refresh").addEventListener("click", load);
  document.getElementById("search").addEventListener("input", load);

  load();
  setInterval(load, 60_000); // refresh every 60 seconds
</script>
</body>
</html>
