<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Office Winter Olympics Sweepstake</title>
  <style>
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
      margin: 24px; 
      max-width: 1100px;
      background-image: url('background.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
    }
    .content-wrapper {
      background: rgba(255, 255, 255, 0.95);
      padding: 24px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }
    h1 { margin: 0 0 6px 0; }
    .sub { color: #555; margin: 0 0 18px 0; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin: 10px 0 18px; }
    input { padding: 10px; border: 1px solid #ddd; border-radius: 10px; min-width: 260px; }
    button { padding: 10px 12px; border: 1px solid #ddd; background: #fff; border-radius: 10px; cursor: pointer; }
    button:hover { background: #f6f6f6; }
    table { border-collapse: collapse; width: 100%; background: white; }
    th, td { border-bottom: 1px solid #eee; padding: 10px 8px; text-align: left; }
    th { font-weight: 650; }
    td.num, th.num { text-align: right; font-variant-numeric: tabular-nums; }
    tr.clickable { cursor: pointer; }
    tr.clickable:hover { background: #fafafa; }
    .pill { display:inline-block; padding: 3px 10px; border: 1px solid #eee; border-radius: 999px; font-size: 12px; color:#555; }
    .muted { color:#777; font-size: 13px; }

    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.28); display: none; }
    .drawer {
      position: fixed; top: 0; right: 0; height: 100%; width: min(560px, 94vw);
      background: #fff; border-left: 1px solid #eee; box-shadow: -10px 0 40px rgba(0,0,0,0.08);
      padding: 18px; overflow: auto; display: none;
    }
    .drawer h2 { margin: 0 0 8px 0; font-size: 20px; }
    .meta { display:flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .tag { background:#f6f6f6; border:1px solid #eee; border-radius: 999px; padding: 4px 10px; font-size: 12px; color:#444; }
    .closeRow { display:flex; justify-content: space-between; align-items: center; gap: 12px; }
    .closeBtn { border-radius: 10px; }
    .kpi { display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 8px 0 14px; }
    .card { border: 1px solid #eee; border-radius: 14px; padding: 10px 12px; }
    .card .big { font-size: 18px; font-weight: 700; }
    .card .lbl { font-size: 12px; color:#666; }
    .sectionTitle { margin: 14px 0 8px; font-size: 14px; color:#555; font-weight: 650; }
    .small { font-size: 12px; color:#666; }

    /* Force emoji-capable fonts for flags (fixes desktop showing LT/ZA letters) */
    .flag-emoji {
      font-family: "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", "Twemoji Mozilla", sans-serif;
      font-size: 1.2em;
      line-height: 1;
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <div class="content-wrapper">
    <h1>Office Winter Olympics Sweepstake</h1>
    <p class="sub">
      Live leaderboard (auto-refreshing). <span id="status" class="pill">Loadingâ€¦</span>
      <span class="pill" style="margin-left:8px;">You can now click player names for a breakdown of their scores! :)</span>
    </p>

    <div class="row">
      <input id="search" placeholder="Search playerâ€¦" />
      <button id="refresh">Refresh now</button>
      <span id="updated" class="muted"></span>
    </div>

    <table id="tbl"></table>
  </div>

  <div id="overlay" class="overlay"></div>
  <div id="drawer" class="drawer"></div>

  <!-- Audio player - hidden but autoplays -->
  <audio id="bgMusic" autoplay loop>
    <source src="music.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

<script>
  // ====== SET THESE TWO URLS ======
  const LEADERBOARD_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTv_B6jdgEx4q3c9uhSISHuVdhUfubFMblfU0FJXop_rv7jniIO_y44H-ARvrjassAOOi0xhDIgxMYW/pub?gid=37582016&single=true&output=csv";
  const MEDALLOG_CSV_URL    = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTv_B6jdgEx4q3c9uhSISHuVdhUfubFMblfU0FJXop_rv7jniIO_y44H-ARvrjassAOOi0xhDIgxMYW/pub?gid=1029591436&single=true&output=csv";

  const withNoCache = (url) => url + (url.includes("?") ? "&" : "?") + "t=" + Date.now();

  function isoToFlag(iso) {
    if (!iso || iso.length !== 2) return "";
    const up = iso.toUpperCase();
    return String.fromCodePoint(
      0x1F1E6 + up.charCodeAt(0) - 65,
      0x1F1E6 + up.charCodeAt(1) - 65
    );
  }

  function parseCSV(text) {
    const rows = [];
    let row = [], field = "", inQuotes = false;
    for (let i = 0; i < text.length; i++) {
      const c = text[i], next = text[i + 1];
      if (c === '"' && inQuotes && next === '"') { field += '"'; i++; continue; }
      if (c === '"') { inQuotes = !inQuotes; continue; }
      if (c === "," && !inQuotes) { row.push(field); field = ""; continue; }
      if ((c === "\n" || c === "\r") && !inQuotes) {
        if (c === "\r" && next === "\n") i++;
        row.push(field);
        if (row.some(x => String(x).trim() !== "")) rows.push(row);
        row = []; field = "";
        continue;
      }
      field += c;
    }
    row.push(field);
    if (row.some(x => String(x).trim() !== "")) rows.push(row);
    return rows;
  }

  const medalPoints = (medal) => {
    const m = String(medal || "").trim().toLowerCase();
    if (m === "gold") return 3;
    if (m === "silver") return 2;
    if (m === "bronze") return 1;
    return 0;
  };

  function toNumber(x) {
    const n = Number(String(x).replace(/[^\d.-]/g, ""));
    return Number.isFinite(n) ? n : 0;
  }

  function escapeHtml(s) {
    return String(s || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function buildIndex(headers) {
    const idx = {};
    headers.forEach((h, i) => idx[String(h).trim().toLowerCase()] = i);
    return idx;
  }

  function ordinal(n) {
    if (!n) return "";
    const s = ["th","st","nd","rd"];
    const v = n % 100;
    return n + (s[(v - 20) % 10] || s[v] || s[0]);
  }

  let leaderboardHeaders = [];
  let lbIdx = {};
  let fullRows = [];
  let medalLog = [];

  let topMedalsByPlayer = {}; // medals by rank 1/2/3
  let positionByPlayer = {};  // dense rank 1,2,2,3,...

  function renderTable(headers, data, onRowClick) {
    const tbl = document.getElementById("tbl");
    tbl.innerHTML = "";

    const hideCols = new Set(["iso1","iso2","iso3"]);

    const visibleCols = [];
    headers.forEach((h, i) => {
      const key = String(h).trim().toLowerCase();
      if (!hideCols.has(key)) visibleCols.push(i);
    });

    const thead = document.createElement("thead");
    const trh = document.createElement("tr");

    const thPos = document.createElement("th");
    thPos.textContent = "Position";
    trh.appendChild(thPos);

    visibleCols.forEach((i) => {
      const h = headers[i];
      const th = document.createElement("th");
      th.textContent = h;
      if (["Gold","Silver","Bronze","Points","Bonus","Total"].includes(h)) th.classList.add("num");
      trh.appendChild(th);
    });

    thead.appendChild(trh);
    tbl.appendChild(thead);

    const tbody = document.createElement("tbody");
    data.forEach(r => {
      const tr = document.createElement("tr");
      tr.classList.add("clickable");
      tr.addEventListener("click", () => onRowClick(r));

      const playerNameForPos = String(r[lbIdx["player"] ?? 0] || "").trim();
      const posNum = positionByPlayer[playerNameForPos];
      const tdPos = document.createElement("td");
      tdPos.textContent = posNum ? ordinal(posNum) : "";
      tr.appendChild(tdPos);

      visibleCols.forEach((i) => {
        const header = headers[i];
        const cell = r[i];

        const td = document.createElement("td");
        const hLower = String(header).trim().toLowerCase();

        if (hLower === "player") {
          const name = String(cell || "");
          const medal = topMedalsByPlayer[String(name).trim()] || "";
          td.textContent = medal ? (medal + " " + name) : name;
        } else if (hLower === "country 1" || hLower === "country 2" || hLower === "country 3") {
          const n = hLower.endsWith("1") ? "1" : (hLower.endsWith("2") ? "2" : "3");
          const isoIdx = lbIdx["iso" + n];
          const isoCode = isoIdx !== undefined ? String(r[isoIdx]).trim().toUpperCase() : "";
          td.innerHTML = `<span class="flag-emoji">${escapeHtml(isoToFlag(isoCode))}</span>${escapeHtml(cell)}`;
        } else {
          td.textContent = cell;
        }

        if (["Gold","Silver","Bronze","Points","Bonus","Total"].includes(header)) td.classList.add("num");
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });
    tbl.appendChild(tbody);
  }

  async function loadMedalLog() {
    const res = await fetch(withNoCache(MEDALLOG_CSV_URL), { cache: "no-store" });
    const text = await res.text();
    const rows = parseCSV(text).filter(r => r.some(c => String(c).trim() !== ""));
    if (rows.length < 2) return [];

    const headers = rows[0].map(h => String(h).trim().toLowerCase());

    const iDate = headers.indexOf("date");
    const iTimestamp = headers.indexOf("timestamp");
    const iSport = headers.indexOf("sport");
    const iEvent = headers.indexOf("event");
    const iMedal = headers.indexOf("medal");
    const iCountry = headers.indexOf("country");
    const iISO = headers.indexOf("iso");

    const dateIdx = iDate >= 0 ? iDate : (iTimestamp >= 0 ? iTimestamp : 0);
    const sportIdx = iSport >= 0 ? iSport : 1;
    const eventIdx = iEvent >= 0 ? iEvent : 2;
    const medalIdx = iMedal >= 0 ? iMedal : 3;
    const countryIdx = iCountry >= 0 ? iCountry : 4;
    const isoIdx = iISO >= 0 ? iISO : 5;

    return rows.slice(1)
      .filter(r => String(r[sportIdx] || "").trim() && String(r[countryIdx] || "").trim() && String(r[medalIdx] || "").trim())
      .map(r => ({
        date: String(r[dateIdx] || "").trim(),
        sport: String(r[sportIdx] || "").trim(),
        event: String(r[eventIdx] || "").trim(),
        medal: String(r[medalIdx] || "").trim(),
        country: String(r[countryIdx] || "").trim(),
        iso: String(r[isoIdx] || "").trim(),
      }));
  }

  async function loadAll() {
    const status = document.getElementById("status");
    status.textContent = "Updatingâ€¦";

    const [lbRes, ml] = await Promise.all([
      fetch(withNoCache(LEADERBOARD_CSV_URL), { cache: "no-store" }),
      loadMedalLog()
    ]);

    medalLog = ml;

    const lbText = await lbRes.text();
    const lbRows = parseCSV(lbText).filter(r => r.some(c => String(c).trim() !== ""));
    if (lbRows.length < 2) {
      status.textContent = "No data yet";
      renderTable(["Player","Gold","Silver","Bronze","Points","Bonus","Total"], [], () => {});
      return;
    }

    leaderboardHeaders = lbRows[0].map(h => String(h).trim());
    lbIdx = buildIndex(leaderboardHeaders);

    const data = lbRows.slice(1)
      .filter(r => String(r[0] || "").trim() !== "")
      .map(r => {
        const padded = [...r];
        while (padded.length < leaderboardHeaders.length) padded.push("");
        return padded;
      })
      .sort((a,b) =>
        toNumber(b[lbIdx["total"] ?? (leaderboardHeaders.length-1)]) - toNumber(a[lbIdx["total"] ?? (leaderboardHeaders.length-1)]) ||
        toNumber(b[lbIdx["points"] ?? 4]) - toNumber(a[lbIdx["points"] ?? 4]) ||
        toNumber(b[lbIdx["gold"] ?? 1]) - toNumber(a[lbIdx["gold"] ?? 1]) ||
        toNumber(b[lbIdx["silver"] ?? 2]) - toNumber(a[lbIdx["silver"] ?? 2]) ||
        toNumber(b[lbIdx["bronze"] ?? 3]) - toNumber(a[lbIdx["bronze"] ?? 3]) ||
        String(a[0]).localeCompare(String(b[0]))
      );

    fullRows = data;

    // Dense ranking by distinct score keys:
    positionByPlayer = {};
    topMedalsByPlayer = {};
    const medalsByRank = { 1: "ðŸ¥‡", 2: "ðŸ¥ˆ", 3: "ðŸ¥‰" };

    let rank = 0;
    let lastKey = null;

    for (let i = 0; i < fullRows.length; i++) {
      const row = fullRows[i];
      const playerName = String(row[lbIdx["player"] ?? 0] || "").trim();
      if (!playerName) continue;

      const key = [
        toNumber(row[lbIdx["total"] ?? (leaderboardHeaders.length-1)]),
        toNumber(row[lbIdx["points"] ?? 4]),
        toNumber(row[lbIdx["gold"] ?? 1]),
        toNumber(row[lbIdx["silver"] ?? 2]),
        toNumber(row[lbIdx["bronze"] ?? 3])
      ].join("|");

      if (lastKey === null || key !== lastKey) {
        rank += 1;
        lastKey = key;
      }

      positionByPlayer[playerName] = rank;
      if (medalsByRank[rank]) topMedalsByPlayer[playerName] = medalsByRank[rank];
    }

    renderTable(leaderboardHeaders, data, showPlayer);

    document.getElementById("updated").textContent =
      "Last refreshed: " + new Date().toLocaleString();

    status.textContent = "Live";
  }

  function applySearch() {
    const q = document.getElementById("search").value.trim().toLowerCase();
    const filtered = !q ? fullRows : fullRows.filter(r => String(r[0]).toLowerCase().includes(q));
    renderTable(leaderboardHeaders, filtered, showPlayer);
  }

  function getCell(row, header, fallbackIndex) {
    const i = lbIdx[header.toLowerCase()];
    return i !== undefined ? row[i] : row[fallbackIndex];
  }

  function showPlayer(row) {
    const player = String(getCell(row, "player", 0) || "").trim();
    const c1 = String(getCell(row, "country 1", 5) || "").trim();
    const c2 = String(getCell(row, "country 2", 6) || "").trim();
    const c3 = String(getCell(row, "country 3", 7) || "").trim();
    const iso1 = String(getCell(row, "iso1", 8) || "").trim().toUpperCase();
    const iso2 = String(getCell(row, "iso2", 9) || "").trim().toUpperCase();
    const iso3 = String(getCell(row, "iso3", 10) || "").trim().toUpperCase();
    const fav = String(getCell(row, "favourite sport", 11) || "").trim();

    const gold = toNumber(getCell(row, "gold", 1));
    const silver = toNumber(getCell(row, "silver", 2));
    const bronze = toNumber(getCell(row, "bronze", 3));
    const points = toNumber(getCell(row, "points", 4));
    const bonus = toNumber(getCell(row, "bonus", 12));
    const total = toNumber(getCell(row, "total", 13));

    const countries = [
      { name: c1, iso: iso1 },
      { name: c2, iso: iso2 },
      { name: c3, iso: iso3 }
    ].filter(c => c.name);
    const favLower = fav.toLowerCase();

    const events = medalLog
      .filter(m => countries.some(c => m.country.toLowerCase() === c.name.toLowerCase()))
      .map(m => {
        const base = medalPoints(m.medal);
        const isBonus = favLower && m.sport.toLowerCase() === favLower;
        const extra = isBonus ? base : 0;
        return { ...m, base, extra, total: base + extra };
      })
      .sort((a,b) => String(b.date).localeCompare(String(a.date)));

    const eventRows = events.length ? events.map(e => {
      const countryInfo = countries.find(c => c.name.toLowerCase() === e.country.toLowerCase());
      const flag = countryInfo ? isoToFlag(countryInfo.iso) : "";
      return `
        <tr>
          <td>${escapeHtml(e.date)}</td>
          <td>${escapeHtml(e.sport)}</td>
          <td>${escapeHtml(e.event || "")}</td>
          <td><span class="flag-emoji">${escapeHtml(flag)}</span>${escapeHtml(e.country)}</td>
          <td>${escapeHtml(e.medal)}</td>
          <td class="num">${e.base}</td>
          <td class="num">${e.extra}</td>
          <td class="num">${e.total}</td>
        </tr>
      `;
    }).join("") : `<tr><td colspan="8" class="small">No medals recorded yet for this player's countries.</td></tr>`;

    const overlay = document.getElementById("overlay");
    const drawer = document.getElementById("drawer");

    const posNum = positionByPlayer[player] || 0;
    const posText = posNum ? ordinal(posNum) : "â€”";
    const medal = topMedalsByPlayer[player] || "";

    drawer.innerHTML = `
      <div class="closeRow">
        <h2>${escapeHtml(player)}</h2>
        <button class="closeBtn" id="closeBtn">Close</button>
      </div>

      <div class="meta">
        <span class="tag">Position: <strong>${escapeHtml(posText)}</strong> ${medal ? medal : ""}</span>
        ${countries.map(c => `<span class="tag"><span class="flag-emoji">${escapeHtml(isoToFlag(c.iso))}</span>${escapeHtml(c.name)}</span>`).join("")}
        <span class="tag">Fav sport: <strong>${escapeHtml(fav || "â€”")}</strong></span>
      </div>

      <div class="kpi">
        <div class="card"><div class="big">${gold}-${silver}-${bronze}</div><div class="lbl">Medals (G-S-B)</div></div>
        <div class="card"><div class="big">${points}</div><div class="lbl">Base points</div></div>
        <div class="card"><div class="big">${bonus} â†’ ${total}</div><div class="lbl">Bonus â†’ Total</div></div>
      </div>

      <div class="sectionTitle">Per-event breakdown</div>
      <div class="small">Base points: Gold=3, Silver=2, Bronze=1. Bonus points are added again when Sport = Favourite sport.</div>

      <table style="width:100%; border-collapse: collapse; margin-top: 8px;">
        <thead>
          <tr>
            <th>Date</th>
            <th>Sport</th>
            <th>Event</th>
            <th>Country</th>
            <th>Medal</th>
            <th class="num">Base</th>
            <th class="num">Bonus</th>
            <th class="num">Total</th>
          </tr>
        </thead>
        <tbody>${eventRows}</tbody>
      </table>
    `;

    overlay.style.display = "block";
    drawer.style.display = "block";

    document.getElementById("closeBtn").addEventListener("click", closeDrawer);
    overlay.addEventListener("click", closeDrawer, { once: true });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeDrawer(); }, { once: true });
  }

  function closeDrawer() {
    document.getElementById("overlay").style.display = "none";
    const drawer = document.getElementById("drawer");
    drawer.style.display = "none";
    drawer.innerHTML = "";
  }

  document.getElementById("refresh").addEventListener("click", loadAll);
  document.getElementById("search").addEventListener("input", applySearch);

  loadAll();
  setInterval(loadAll, 60_000);
</script>
</body>
</html>
