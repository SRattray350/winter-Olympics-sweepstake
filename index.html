<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Office Winter Olympics Sweepstake</title>

<style>
  body {
    margin: 0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;

    /* IMPORTANT: rename your uploaded image to background.jpg OR edit this filename */
    background:
      linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)),
      url("./background.jpg");

    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    min-height: 100vh;
    color: #111;
  }

  .wrap {
    max-width: 1000px;
    margin: 0 auto;
    padding: 24px;
  }

  .card {
    background: rgba(255,255,255,0.92);
    border-radius: 18px;
    padding: 18px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.25);
  }

  h1 { margin: 0 0 6px; }
  .sub { color: #555; margin-bottom: 14px; }

  .row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 14px;
  }

  input {
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #ddd;
    min-width: 260px;
  }

  button {
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid #ddd;
    background: #fff;
    cursor: pointer;
    font-weight: 600;
  }
  button:hover { background: #f4f4f4; }

  .pill {
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid #ddd;
    font-size: 12px;
    color: #444;
    background: rgba(255,255,255,0.75);
  }

  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 10px 8px; border-bottom: 1px solid #e0e0e0; }
  th { text-align: left; font-weight: 700; }
  td.num, th.num { text-align: right; font-variant-numeric: tabular-nums; }

  img.flag {
    vertical-align: middle;
    margin-right: 6px;
    border-radius: 2px;
    border: 1px solid rgba(0,0,0,0.15);
  }

  #yt { width: 0; height: 0; overflow: hidden; }
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>Office Winter Olympics Sweepstake</h1>
    <p class="sub">
      Live leaderboard <span id="status" class="pill">Loading‚Ä¶</span>
    </p>

    <div class="row">
      <input id="search" placeholder="Search player‚Ä¶" />
      <button id="refresh">Refresh</button>
      <button id="musicBtn">üî• Intense music</button>
      <span id="updated" class="pill"></span>
    </div>

    <table id="tbl"></table>
  </div>
</div>

<div id="yt"></div>

<script>
/* ============================
   CONFIG
============================ */
const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vTv_B6jdgEx4q3c9uhSISHuVdhUfubFMblfU0FJXop_rv7jniIO_y44H-ARvrjassAOOi0xhDIgxMYW/pub?gid=37582016&single=true&output=csv";

const VIDEO_ID = "zRs58D34OLY";

/* ============================
   HELPERS
============================ */
const csvNoCache = () => CSV_URL + "&t=" + Date.now();

function parseCSV(text) {
  const rows = [];
  let row = [], field = "", inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const c = text[i], n = text[i+1];
    if (c === '"' && inQuotes && n === '"') { field += '"'; i++; continue; }
    if (c === '"') { inQuotes = !inQuotes; continue; }
    if (c === "," && !inQuotes) { row.push(field); field=""; continue; }
    if ((c === "\n" || c === "\r") && !inQuotes) {
      if (c === "\r" && n === "\n") i++;
      row.push(field); rows.push(row);
      row=[]; field=""; continue;
    }
    field += c;
  }
  row.push(field); rows.push(row);
  return rows.filter(r => r.some(x => String(x).trim() !== ""));
}

function toNum(x){
  const n = Number(String(x).replace(/[^\d.-]/g,""));
  return Number.isFinite(n) ? n : 0;
}

function flag(code){
  if(!code) return "";
  const c = String(code).trim().toLowerCase();
  return `<img class="flag" src="https://flagcdn.com/w20/${c}.png"
          srcset="https://flagcdn.com/w40/${c}.png 2x"
          width="20" height="15" alt="${c}">`;
}

function headerMap(headers){
  const m = new Map();
  headers.forEach((h, i) => m.set(String(h).trim().toLowerCase(), i)); // TRIM is key
  return m;
}

/* ============================
   LOAD & RENDER
============================ */
let fullHeaders = [];
let fullData = [];

async function load(){
  document.getElementById("status").textContent = "Updating‚Ä¶";

  const res = await fetch(csvNoCache(), {cache:"no-store"});
  const text = await res.text();
  const rows = parseCSV(text);
  if(rows.length < 2) {
    document.getElementById("status").textContent = "No data";
    return;
  }

  const headers = rows[0];
  const h = headerMap(headers);

  // Indexes (robust to trailing spaces)
  const idxPlayer = h.get("player") ?? 0;
  const idxGold   = h.get("gold");
  const idxSilver = h.get("silver");
  const idxBronze = h.get("bronze");
  const idxTotal  = h.get("total") ?? h.get("points"); // fallback if you haven't added Total column yet

  const idxC1  = h.get("country 1");
  const idxC2  = h.get("country 2");
  const idxC3  = h.get("country 3");
  const idxISO1 = h.get("iso1");
  const idxISO2 = h.get("iso2");
  const idxISO3 = h.get("iso3");

  const data = rows.slice(1).filter(r => String(r[idxPlayer] || "").trim() !== "");

  // Sort by Total (or Points), then Gold/Silver/Bronze
  data.sort((a,b) =>
    (idxTotal  != null ? toNum(b[idxTotal])  - toNum(a[idxTotal])  : 0) ||
    (idxGold   != null ? toNum(b[idxGold])   - toNum(a[idxGold])   : 0) ||
    (idxSilver != null ? toNum(b[idxSilver]) - toNum(a[idxSilver]) : 0) ||
    (idxBronze != null ? toNum(b[idxBronze]) - toNum(a[idxBronze]) : 0) ||
    String(a[idxPlayer]).localeCompare(String(b[idxPlayer]))
  );

  fullHeaders = headers;
  fullData = data;

  applySearchAndRender({
    idxPlayer, idxGold, idxSilver, idxBronze, idxTotal,
    idxC1, idxC2, idxC3, idxISO1, idxISO2, idxISO3
  });

  document.getElementById("updated").textContent =
    "Updated " + new Date().toLocaleTimeString();
  document.getElementById("status").textContent = "Live";
}

function applySearchAndRender(idxs){
  const q = document.getElementById("search").value.trim().toLowerCase();
  const filtered = !q ? fullData : fullData.filter(r => String(r[idxs.idxPlayer]).toLowerCase().includes(q));

  const tbl = document.getElementById("tbl");
  tbl.innerHTML = "";

  const thead = document.createElement("thead");
  thead.innerHTML = `
    <tr>
      <th>Player</th>
      <th class="num">Gold</th>
      <th class="num">Silver</th>
      <th class="num">Bronze</th>
      <th class="num">${(idxs.idxTotal != null && String(fullHeaders[idxs.idxTotal]).trim()) || "Total"}</th>
      <th>Countries</th>
    </tr>`;
  tbl.appendChild(thead);

  const tbody = document.createElement("tbody");
  filtered.forEach(r => {
    const gold = idxs.idxGold != null ? (r[idxs.idxGold] ?? "0") : "0";
    const silver = idxs.idxSilver != null ? (r[idxs.idxSilver] ?? "0") : "0";
    const bronze = idxs.idxBronze != null ? (r[idxs.idxBronze] ?? "0") : "0";
    const total = idxs.idxTotal != null ? (r[idxs.idxTotal] ?? "0") : "0";

    const c1 = idxs.idxC1 != null ? (r[idxs.idxC1] ?? "") : "";
    const c2 = idxs.idxC2 != null ? (r[idxs.idxC2] ?? "") : "";
    const c3 = idxs.idxC3 != null ? (r[idxs.idxC3] ?? "") : "";

    const iso1 = idxs.idxISO1 != null ? r[idxs.idxISO1] : "";
    const iso2 = idxs.idxISO2 != null ? r[idxs.idxISO2] : "";
    const iso3 = idxs.idxISO3 != null ? r[idxs.idxISO3] : "";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r[idxs.idxPlayer]}</td>
      <td class="num">${gold}</td>
      <td class="num">${silver}</td>
      <td class="num">${bronze}</td>
      <td class="num"><b>${total}</b></td>
      <td>
        ${flag(iso1)}${c1}&nbsp;&nbsp;
        ${flag(iso2)}${c2}&nbsp;&nbsp;
        ${flag(iso3)}${c3}
      </td>`;
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
}

document.getElementById("refresh").onclick = load;
document.getElementById("search").addEventListener("input", () => {
  // re-render from cached data without refetching
  const headers = fullHeaders;
  if (!headers.length) return;
  const h = headerMap(headers);
  applySearchAndRender({
    idxPlayer: h.get("player") ?? 0,
    idxGold: h.get("gold"),
    idxSilver: h.get("silver"),
    idxBronze: h.get("bronze"),
    idxTotal: h.get("total") ?? h.get("points"),
    idxC1: h.get("country 1"),
    idxC2: h.get("country 2"),
    idxC3: h.get("country 3"),
    idxISO1: h.get("iso1"),
    idxISO2: h.get("iso2"),
    idxISO3: h.get("iso3"),
  });
});

load();
setInterval(load, 60000);

/* ============================
   MUSIC
============================ */
let playing = false;
document.getElementById("musicBtn").onclick = () => {
  const yt = document.getElementById("yt");
  if(!playing){
    yt.innerHTML =
      `<iframe width="0" height="0"
        src="https://www.youtube.com/embed/${VIDEO_ID}?autoplay=1&loop=1&playlist=${VIDEO_ID}"
        allow="autoplay"></iframe>`;
    document.getElementById("musicBtn").textContent = "‚è∏ Stop music";
    playing = true;
  } else {
    yt.innerHTML = "";
    document.getElementById("musicBtn").textContent = "üî• Intense music";
    playing = false;
  }
};
</script>
</body>
</html>
