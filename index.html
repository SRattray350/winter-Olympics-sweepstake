<script>
  // ... keep everything above exactly the same ...

  function isoToFlag(iso) {
    const s = String(iso || "").trim().toUpperCase();
    if (!/^[A-Z]{2}$/.test(s)) return "";
    const A = 0x1F1E6; // Regional Indicator Symbol Letter A
    const codePoints = [...s].map(ch => A + (ch.charCodeAt(0) - 65));
    return String.fromCodePoint(...codePoints);
  }

  function renderTable(headers, data, onRowClick, hiddenIdxSet) {
    const tbl = document.getElementById("tbl");
    tbl.innerHTML = "";

    const visibleHeaders = headers
      .map((h, i) => ({ h, i }))
      .filter(x => !hiddenIdxSet.has(x.i));

    const thead = document.createElement("thead");
    const trh = document.createElement("tr");
    visibleHeaders.forEach(({ h }) => {
      const th = document.createElement("th");
      th.textContent = h;
      if (["Gold","Silver","Bronze","Points","Bonus","Total"].includes(h)) th.classList.add("num");
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    tbl.appendChild(thead);

    const tbody = document.createElement("tbody");
    data.forEach(r => {
      const tr = document.createElement("tr");
      tr.classList.add("clickable");
      tr.addEventListener("click", () => onRowClick(r)); // IMPORTANT: pass original row for drawer

      visibleHeaders.forEach(({ h, i }) => {
        const td = document.createElement("td");
        td.textContent = r[i];
        if (["Gold","Silver","Bronze","Points","Bonus","Total"].includes(h)) td.classList.add("num");
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });
    tbl.appendChild(tbody);
  }

  // ... keep buildIndex, loadMedalLog, etc. the same ...

  async function loadAll() {
    const status = document.getElementById("status");
    status.textContent = "Updatingâ€¦";

    const [lbRes, ml] = await Promise.all([
      fetch(withNoCache(LEADERBOARD_CSV_URL), { cache: "no-store" }),
      loadMedalLog()
    ]);

    medalLog = ml;

    const lbText = await lbRes.text();
    const lbRows = parseCSV(lbText).filter(r => r.some(c => String(c).trim() !== ""));
    if (lbRows.length < 2) {
      status.textContent = "No data yet";
      renderTable(["Player","Gold","Silver","Bronze","Points","Bonus","Total"], [], () => {}, new Set());
      return;
    }

    leaderboardHeaders = lbRows[0].map(h => String(h).trim());
    lbIdx = buildIndex(leaderboardHeaders);

    // Identify the ISO columns (to hide) + country columns (to decorate)
    const iso1Idx = lbIdx["iso1"];
    const iso2Idx = lbIdx["iso2"];
    const iso3Idx = lbIdx["iso3"];
    const c1Idx = lbIdx["country 1"];
    const c2Idx = lbIdx["country 2"];
    const c3Idx = lbIdx["country 3"];

    const hiddenIdxSet = new Set([iso1Idx, iso2Idx, iso3Idx].filter(i => i !== undefined));

    const data = lbRows.slice(1)
      .filter(r => String(r[0] || "").trim() !== "")
      .map(r => {
        const padded = [...r];
        while (padded.length < leaderboardHeaders.length) padded.push("");

        // Add flags into Country 1/2/3 cells using ISO1/2/3
        if (c1Idx !== undefined && iso1Idx !== undefined) {
          const flag = isoToFlag(padded[iso1Idx]);
          if (flag) padded[c1Idx] = `${flag} ${padded[c1Idx]}`.trim();
        }
        if (c2Idx !== undefined && iso2Idx !== undefined) {
          const flag = isoToFlag(padded[iso2Idx]);
          if (flag) padded[c2Idx] = `${flag} ${padded[c2Idx]}`.trim();
        }
        if (c3Idx !== undefined && iso3Idx !== undefined) {
          const flag = isoToFlag(padded[iso3Idx]);
          if (flag) padded[c3Idx] = `${flag} ${padded[c3Idx]}`.trim();
        }

        return padded;
      })
      .sort((a,b) =>
        toNumber(b[lbIdx["total"] ?? (leaderboardHeaders.length-1)]) - toNumber(a[lbIdx["total"] ?? (leaderboardHeaders.length-1)]) ||
        toNumber(b[lbIdx["points"] ?? 4]) - toNumber(a[lbIdx["points"] ?? 4]) ||
        toNumber(b[lbIdx["gold"] ?? 1]) - toNumber(a[lbIdx["gold"] ?? 1]) ||
        toNumber(b[lbIdx["silver"] ?? 2]) - toNumber(a[lbIdx["silver"] ?? 2]) ||
        toNumber(b[lbIdx["bronze"] ?? 3]) - toNumber(a[lbIdx["bronze"] ?? 3]) ||
        String(a[0]).localeCompare(String(b[0]))
      );

    fullRows = data;

    // Also hide the ISO headers
    const headersForTable = [...leaderboardHeaders];

    renderTable(headersForTable, data, showPlayer, hiddenIdxSet);

    document.getElementById("updated").textContent =
      "Last refreshed: " + new Date().toLocaleString();

    status.textContent = "Live";
  }

  // ... keep applySearch the same EXCEPT it must pass hiddenIdxSet too (see below)
</script>
